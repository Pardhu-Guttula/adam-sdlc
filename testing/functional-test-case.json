[
  {
    "file_path": "backend/authentication/controllers/mfa_controller.py",
    "file_content": "# Epic Title: User Authentication and MFA\n\nfrom flask import Blueprint, request, jsonify\nfrom sqlalchemy.exc import SQLAlchemyError\nfrom backend.database.config import get_db\nfrom backend.authentication.repositories.mfa_repository import MFARepository\nfrom backend.authentication.services.mfa_service import MFAService\n\nmfa_bp = Blueprint('mfa', __name__)\n\n@mfa_bp.route('/mfa/setup', methods=['POST'])\ndef setup_mfa():\n    db = next(get_db())\n    data = request.get_json()\n\n    account_id = data.get('account_id')\n    mfa_method = data.get('mfa_method')\n\n    mfa_repository = MFARepository(db)\n    mfa_service = MFAService(mfa_repository)\n\n    try:\n        result = mfa_service.setup_mfa(db, account_id, mfa_method)\n        return jsonify(result), 201\n    except SQLAlchemyError as e:\n        return jsonify({\"error\": \"Unable to process your request\"}), 500\n\n@mfa_bp.route('/mfa/activate', methods=['POST'])\ndef activate_mfa():\n    db = next(get_db())\n    data = request.get_json()\n\n    account_id = data.get('account_id')\n    mfa_method = data.get('mfa_method')\n\n    mfa_repository = MFARepository(db)\n    mfa_service = MFAService(mfa_repository)\n\n    try:\n        result = mfa_service.activate_mfa(db, account_id, mfa_method)\n        return jsonify(result), 201\n    except SQLAlchemyError as e:\n        return jsonify({\"error\": \"Unable to process your request\"}), 500\n\n@mfa_bp.route('/mfa/validate', methods=['POST'])\ndef validate_mfa_token():\n    db = next(get_db())\n    data = request.get_json()\n\n    account_id = data.get('account_id')\n    token = data.get('token')\n\n    mfa_repository = MFARepository(db)\n    mfa_service = MFAService(mfa_repository)\n\n    try:\n        result = mfa_service.validate_mfa_token(db, account_id, token)\n        status_code = 200 if result['success'] else 401\n        return jsonify(result), status_code\n    except SQLAlchemyError as e:\n        return jsonify({\"error\": \"Unable to process your request\"}), 500\n"
  },
  {
    "file_path": "backend/authentication/controllers/auth_controller.py",
    "file_content": "# Epic Title: User Authentication and MFA\n\nfrom fastapi import APIRouter, HTTPException, status\nfrom backend.authentication.services.auth_service import AuthService\nfrom backend.authentication.models.user import User\nimport logging\n\nrouter = APIRouter()\nservice = AuthService()\n\nlogging.basicConfig(level=logging.INFO)\nlogger = logging.getLogger(__name__)\n\n@router.post(\"/store\")\nasync def store_user(user: User):\n    logger.info(f\"Storing user credentials: {user.email}\")\n    try:\n        service.store_user_credentials(user)\n        return {\"message\": \"User credentials stored successfully\"}\n    except Exception as e:\n        logger.error(f\"Error storing user credentials: {e}\")\n        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail=\"Internal server error\")\n\n@router.get(\"/retrieve\")\nasync def retrieve_user(email: str):\n    logger.info(f\"Retrieving user credentials for email: {email}\")\n    try:\n        user = service.get_user_credentials(email)\n        if not user:\n            raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail=\"User not found\")\n        return {\"email\": user.email, \"password\": user.password}\n    except Exception as e:\n        logger.error(f\"Error retrieving user credentials: {e}\")\n        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail=\"Internal server error\")\n"
  },
  {
    "file_path": "backend/authentication/controllers/login_controller.py",
    "file_content": "# Epic Title: User Authentication and MFA\n\nfrom flask import Blueprint, request, jsonify\nfrom backend.authentication.services.authentication_service import AuthenticationService\nfrom backend.authentication.models.user import User\nimport logging\n\nlogin_controller = Blueprint('login_controller', __name__)\nauth_service = AuthenticationService()\n\nlogging.basicConfig(level=logging.INFO)\nlogger = logging.getLogger(__name__)\n\n@login_controller.route('/login', methods=['POST'])\ndef login():\n    data = request.json\n    logger.info(\"Login attempt with provided credentials.\")\n    email = data.get('email')\n    password = data.get('password')\n    \n    if not email or not password:\n        logger.error(\"Email or password not provided.\")\n        return jsonify({'error': 'Email and password are required'}), 400\n\n    user = auth_service.authenticate(email, password)\n    if user:\n        token = auth_service.generate_session_token(user)\n        logger.info(f\"User {email} logged in successfully.\")\n        return jsonify({'message': 'Login successful', 'token': token}), 200\n    else:\n        logger.warning(f\"Invalid login attempt for email {email}.\")\n        return jsonify({'error': 'Invalid credentials'}), 401\n\n@login_controller.route('/validate', methods=['POST'])\ndef validate():\n    data = request.json\n    email = data.get('email')\n    \n    if '@' not in email:\n        return jsonify({'error': 'Invalid email format'}), 400\n    \n    return jsonify({'message': 'Valid email format'}), 200\n"
  }
]